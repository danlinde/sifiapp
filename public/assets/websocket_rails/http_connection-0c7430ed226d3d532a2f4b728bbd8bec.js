(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};WebSocketRails.HttpConnection=function(){function e(e,n){this.url=e,this.dispatcher=n,this.connectionClosed=t(this.connectionClosed,this),this.flush_queue=t(this.flush_queue,this),this.trigger=t(this.trigger,this),this.parse_stream=t(this.parse_stream,this),this.createXMLHttpObject=t(this.createXMLHttpObject,this),this._url=this.url,this._conn=this.createXMLHttpObject(),this.last_pos=0,this.message_queue=[],this._conn.onreadystatechange=this.parse_stream,this._conn.addEventListener("load",this.connectionClosed,!1),this._conn.open("GET",this._url,!0),this._conn.send()}return e.prototype.httpFactories=function(){return[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]},e.prototype.createXMLHttpObject=function(){var t,e,n,s,i,r;for(s=!1,e=this.httpFactories(),i=0,r=e.length;r>i;i++){n=e[i];try{s=n()}catch(o){t=o;continue}break}return s},e.prototype.parse_stream=function(){var t,e;return 3===this._conn.readyState?(t=this._conn.responseText.substring(this.last_pos),this.last_pos=this._conn.responseText.length,t=t.replace(/\]\]\[\[/g,"],["),e=JSON.parse(t),this.dispatcher.new_message(e)):void 0},e.prototype.trigger=function(t){return"connected"!==this.dispatcher.state?this.message_queue.push(t):this.post_data(this.dispatcher.connection_id,t.serialize())},e.prototype.post_data=function(t,e){return $.ajax(this._url,{type:"POST",data:{client_id:t,data:e},success:function(){}})},e.prototype.flush_queue=function(t){var e,n,s,i;for(i=this.message_queue,n=0,s=i.length;s>n;n++)e=i[n],null!=t&&(e.connection_id=this.dispatcher.connection_id),this.trigger(e);return this.message_queue=[]},e.prototype.connectionClosed=function(t){var e;return e=new WebSocketRails.Event(["connection_closed",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(e)},e}()}).call(this);