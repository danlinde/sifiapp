(function(){var t=function(t,s){return function(){return t.apply(s,arguments)}};this.WebSocketRails=function(){function s(e,n){this.url=e,this.use_websockets=null!=n?n:!0,this.connection_stale=t(this.connection_stale,this),this.pong=t(this.pong,this),this.supports_websockets=t(this.supports_websockets,this),this.dispatch_channel=t(this.dispatch_channel,this),this.unsubscribe=t(this.unsubscribe,this),this.subscribe_private=t(this.subscribe_private,this),this.subscribe=t(this.subscribe,this),this.dispatch=t(this.dispatch,this),this.trigger_event=t(this.trigger_event,this),this.trigger=t(this.trigger,this),this.bind=t(this.bind,this),this.connection_established=t(this.connection_established,this),this.new_message=t(this.new_message,this),this.state="connecting",this.callbacks={},this.channels={},this.queue={},this._conn=this.supports_websockets()&&this.use_websockets?new s.WebSocketConnection(e,this):new s.HttpConnection(e,this),this._conn.new_message=this.new_message}return s.prototype.new_message=function(t){var e,n,i,c,r,h;for(h=[],i=0,c=t.length;c>i;i++)n=t[i],e=new s.Event(n),e.is_result()?(null!=(r=this.queue[e.id])&&r.run_callbacks(e.success,e.data),this.queue[e.id]=null):e.is_channel()?this.dispatch_channel(e):e.is_ping()?this.pong():this.dispatch(e),"connecting"===this.state&&"client_connected"===e.name?h.push(this.connection_established(e.data)):h.push(void 0);return h},s.prototype.connection_established=function(t){return this.state="connected",this.connection_id=t.connection_id,this._conn.flush_queue(t.connection_id),null!=this.on_open?this.on_open(t):void 0},s.prototype.bind=function(t,s){var e;return null==(e=this.callbacks)[t]&&(e[t]=[]),this.callbacks[t].push(s)},s.prototype.trigger=function(t,e,n,i){var c;return c=new s.Event([t,e,this.connection_id],n,i),this.queue[c.id]=c,this._conn.trigger(c)},s.prototype.trigger_event=function(t){var s,e;return null==(s=this.queue)[e=t.id]&&(s[e]=t),this._conn.trigger(t)},s.prototype.dispatch=function(t){var s,e,n,i,c;if(null!=this.callbacks[t.name]){for(i=this.callbacks[t.name],c=[],e=0,n=i.length;n>e;e++)s=i[e],c.push(s(t.data));return c}},s.prototype.subscribe=function(t){var e;return null==this.channels[t]?(e=new s.Channel(t,this),this.channels[t]=e,e):this.channels[t]},s.prototype.subscribe_private=function(t){var e;return null==this.channels[t]?(e=new s.Channel(t,this,!0),this.channels[t]=e,e):this.channels[t]},s.prototype.unsubscribe=function(t){return null!=this.channels[t]?(this.channels[t].destroy(),delete this.channels[t]):void 0},s.prototype.dispatch_channel=function(t){return null!=this.channels[t.channel]?this.channels[t.channel].dispatch(t.name,t.data):void 0},s.prototype.supports_websockets=function(){return"function"==typeof WebSocket||"object"==typeof WebSocket},s.prototype.pong=function(){var t;return t=new s.Event(["websocket_rails.pong",{},this.connection_id]),this._conn.trigger(t)},s.prototype.connection_stale=function(){return"connected"!==this.state},s}()}).call(this),function(){var t=function(t,s){return function(){return t.apply(s,arguments)}};WebSocketRails.Event=function(){function s(s,e,n){var i;this.success_callback=e,this.failure_callback=n,this.run_callbacks=t(this.run_callbacks,this),this.attributes=t(this.attributes,this),this.serialize=t(this.serialize,this),this.is_ping=t(this.is_ping,this),this.is_result=t(this.is_result,this),this.is_channel=t(this.is_channel,this),this.name=s[0],i=s[1],null!=i&&(this.id=null!=i.id?i.id:0|65536*(1+Math.random()),this.channel=null!=i.channel?i.channel:void 0,this.data=null!=i.data?i.data:i,this.connection_id=s[2],null!=i.success&&(this.result=!0,this.success=i.success))}return s.prototype.is_channel=function(){return null!=this.channel},s.prototype.is_result=function(){return this.result===!0},s.prototype.is_ping=function(){return"websocket_rails.ping"===this.name},s.prototype.serialize=function(){return JSON.stringify([this.name,this.attributes()])},s.prototype.attributes=function(){return{id:this.id,channel:this.channel,data:this.data}},s.prototype.run_callbacks=function(t,s){return t===!0?"function"==typeof this.success_callback?this.success_callback(s):void 0:"function"==typeof this.failure_callback?this.failure_callback(s):void 0},s}()}.call(this),function(){var t=function(t,s){return function(){return t.apply(s,arguments)}};WebSocketRails.HttpConnection=function(){function s(s,e){this.url=s,this.dispatcher=e,this.connectionClosed=t(this.connectionClosed,this),this.flush_queue=t(this.flush_queue,this),this.trigger=t(this.trigger,this),this.parse_stream=t(this.parse_stream,this),this.createXMLHttpObject=t(this.createXMLHttpObject,this),this._url=this.url,this._conn=this.createXMLHttpObject(),this.last_pos=0,this.message_queue=[],this._conn.onreadystatechange=this.parse_stream,this._conn.addEventListener("load",this.connectionClosed,!1),this._conn.open("GET",this._url,!0),this._conn.send()}return s.prototype.httpFactories=function(){return[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}]},s.prototype.createXMLHttpObject=function(){var t,s,e,n,i,c;for(n=!1,s=this.httpFactories(),i=0,c=s.length;c>i;i++){e=s[i];try{n=e()}catch(r){t=r;continue}break}return n},s.prototype.parse_stream=function(){var t,s;return 3===this._conn.readyState?(t=this._conn.responseText.substring(this.last_pos),this.last_pos=this._conn.responseText.length,t=t.replace(/\]\]\[\[/g,"],["),s=JSON.parse(t),this.dispatcher.new_message(s)):void 0},s.prototype.trigger=function(t){return"connected"!==this.dispatcher.state?this.message_queue.push(t):this.post_data(this.dispatcher.connection_id,t.serialize())},s.prototype.post_data=function(t,s){return $.ajax(this._url,{type:"POST",data:{client_id:t,data:s},success:function(){}})},s.prototype.flush_queue=function(t){var s,e,n,i;for(i=this.message_queue,e=0,n=i.length;n>e;e++)s=i[e],null!=t&&(s.connection_id=this.dispatcher.connection_id),this.trigger(s);return this.message_queue=[]},s.prototype.connectionClosed=function(t){var s;return s=new WebSocketRails.Event(["connection_closed",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(s)},s}()}.call(this),function(){var t=function(t,s){return function(){return t.apply(s,arguments)}};WebSocketRails.WebSocketConnection=function(){function s(s,e){this.url=s,this.dispatcher=e,this.flush_queue=t(this.flush_queue,this),this.on_error=t(this.on_error,this),this.on_close=t(this.on_close,this),this.on_message=t(this.on_message,this),this.trigger=t(this.trigger,this),this.url.match(/^wss?:\/\//)?console.log("WARNING: Using connection urls with protocol specified is depricated"):this.url="http:"===window.location.protocol?"ws://"+this.url:"wss://"+this.url,this.message_queue=[],this._conn=new WebSocket(this.url),this._conn.onmessage=this.on_message,this._conn.onclose=this.on_close,this._conn.onerror=this.on_error}return s.prototype.trigger=function(t){return"connected"!==this.dispatcher.state?this.message_queue.push(t):this._conn.send(t.serialize())},s.prototype.on_message=function(t){var s;return s=JSON.parse(t.data),this.dispatcher.new_message(s)},s.prototype.on_close=function(t){var s;return s=new WebSocketRails.Event(["connection_closed",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(s)},s.prototype.on_error=function(t){var s;return s=new WebSocketRails.Event(["connection_error",t]),this.dispatcher.state="disconnected",this.dispatcher.dispatch(s)},s.prototype.flush_queue=function(){var t,s,e,n;for(n=this.message_queue,s=0,e=n.length;e>s;s++)t=n[s],this._conn.send(t.serialize());return this.message_queue=[]},s}()}.call(this),function(){var t=function(t,s){return function(){return t.apply(s,arguments)}};WebSocketRails.Channel=function(){function s(s,e,n){var i,c;this.name=s,this._dispatcher=e,this.is_private=n,this._failure_launcher=t(this._failure_launcher,this),this._success_launcher=t(this._success_launcher,this),this.dispatch=t(this.dispatch,this),this.trigger=t(this.trigger,this),this.bind=t(this.bind,this),this.destroy=t(this.destroy,this),c=this.is_private?"websocket_rails.subscribe_private":"websocket_rails.subscribe",i=new WebSocketRails.Event([c,{data:{channel:this.name}},this._dispatcher.connection_id],this._success_launcher,this._failure_launcher),this._dispatcher.trigger_event(i),this._callbacks={}}return s.prototype.destroy=function(){var t,s;return s="websocket_rails.unsubscribe",t=new WebSocketRails.Event([s,{data:{channel:this.name}},this._dispatcher.connection_id]),this._dispatcher.trigger_event(t),this._callbacks={}},s.prototype.bind=function(t,s){var e;return null==(e=this._callbacks)[t]&&(e[t]=[]),this._callbacks[t].push(s)},s.prototype.trigger=function(t,s){var e;return e=new WebSocketRails.Event([t,{channel:this.name,data:s},this._dispatcher.connection_id]),this._dispatcher.trigger_event(e)},s.prototype.dispatch=function(t,s){var e,n,i,c,r;if(null!=this._callbacks[t]){for(c=this._callbacks[t],r=[],n=0,i=c.length;i>n;n++)e=c[n],r.push(e(s));return r}},s.prototype._success_launcher=function(t){return null!=this.on_success?this.on_success(t):void 0},s.prototype._failure_launcher=function(t){return null!=this.on_failure?this.on_failure(t):void 0},s}()}.call(this);